<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>sai - 简介</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="nico 0.5.1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link type="image/x-icon" href="../static/css/favicon.ico" rel="icon">
    <link rel="stylesheet" href="../static/css/normalize.css" />
    <link rel="stylesheet" href="../static/css/site.css" />
    <link rel="stylesheet" href="../static/css/solarized.css" />
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-50522089-2', 'spm documentation');
  ga('send', 'pageview');
</script>
<script src="http://static.alipayobjects.com/seajs/seajs/2.2.0/sea.js"></script>

<script>
  (function() {
  seajs.config({
    base: "../"
  });

  seajs.config({
    alias: {"arale-events":"sea-modules/arale-events/1.2.0/events.js","detector":"sea-modules/detector/2.0.1/detector.js","expect.js":"sea-modules/expect.js/0.3.1/index.js","jquery":"sea-modules/jquery/1.7.2/jquery.js"}
  });
})();
</script>
    <!--[if lt IE 9]>
    <script src="../static/js/html5shiv.js"></script>
    <![endif]-->
  </head>
  <body class="spmjs">
    <div class="body-wrapper">
      <aside class="sidebar-wrapper">
      <h1>
          <a href="../">Sai</a>
      </h1>
        <p class="sidebar-version">Version: <a href="http://spmjs.io/package/sai" title="">3.0.0</a></p>
        <p class="sidebar-description" data-keyword="utility">通用前端监控脚本</p>
        <a class="sidebar-source" href="https://github.com/saijs/sai.js" target="_blank">View the Project</a>
        <ul class="sidebar-navigation" role="navigation">
          <li><a href="../">Doc</a></li>
          <li><a href="../examples/">Demo</a></li>
          <li><a class="test-link" href="../tests/runner.html" target="_blank">Test</a></li>
        </ul>
        
<ol class="sidenav">
  <li><a href="index.html">前端监控脚本</a></li>
  <li><a href="intro.html">简介</a></li>
  <li><a href="data-specification-v2.html">数据通信规格(v2)</a></li>
  <li><a href="JSniffer.html">JSniffer</a></li>
  <li><a href="install.html">安装部署</a></li>
  <li><a href="data-specification-v1.html">数据通信规格(v1)</a></li>
  <li><a href="others.html">其他</a></li>
  <li><a href="script-crossorigin.html">script[crossorigin]</a></li>
  <li><a href="sourcemap.html">SourceMap</a></li>
  <li><a href="stack-trace.html">Stack Trace</a></li>
  <li><a href="window-onerror.html">window.onerror</a></li>
</ol>

      </aside>
      <div class="content-wrapper">
        
<article class="hentry">
  <h1 class="entry-title">简介</h1>
  <div class="entry-content">
    <p>前端监控脚本用户监控脚本用户浏览器端运行时异常检查，也附带实现了部分静态资源的检查。</p>
<p>主要包括以下几个部分：</p>
<ul>
<li>JavaScript 运行时异常嗅探；</li>
<li>HTML 源码解析并执行规则校验；</li>
<li>DOM 结构遍历并执行规则校验；</li>
<li>CSS 静态文件解析并执行规则校验；</li>
<li>运行时 DOM CSS 渲染结果并检查/统计特定属性；</li>
</ul>
<h2 id="jsniffer">JSniffer<a href="#jsniffer" class="anchor">¶</a></h2><p>JSniffer 模块用于嗅探 JavaScript 异常情况，绑定 window.onerror 处理函数，
脚本抛出异常时，嗅探收集、处理&amp;整理、汇报到服务端。</p>
<p>使用 window.onerror 而不是 addEventListener，在于onerror 处理函数接受的参数
一致并具有实用性，而 addEventListener/attachEvent 方式各浏览器传递的参数不一致
（有传 Event 对象）且不具实用性）。</p>
<p>监控脚本无法捕获的异常：</p>
<ol>
<li>window.onerror 函数绑定之前的脚本异常；</li>
<li>window.onerror 本身所在的 <script> 块有异常，导致绑定失败。</li>
</ol>
<p>策略是：</p>
<ol>
<li>将 JavaScript异常监控脚本放置文档最前面（至少是其他 <script> 块之前）；</li>
<li>JavaScript 异常监控脚本独立在一个 <script> 块中（建议是外部脚本文件，亦可使用缓存）；</li>
</ol>
<p>JavaScript 异常包括：</p>
<ol>
<li>通常意义上的脚本运行时异常；</li>
<li>脚本（多出现于 JSON/JSONP 请求）加载失败。</li>
</ol>
<p>JSON/JSONP 一般会带比较长的参数，每次请求都可能不一样，甚至为了避免缓存加上随机数，
这些参数数据在在错误文件地址中，基本是没有用处，可以删除，只保留地址部分。</p>
<h2 id="domlint">DOMLint<a href="#domlint" class="anchor">¶</a></h2><p>DOMLint 在 DOMReady （一段时间）之后，遍历整个 DOM 校验一遍规则，最终收集到的
异常信息汇报到服务端。</p>
<p>遍历的规则包括标签的非法嵌套，过期标签的使用，出现重复 ID 等规则，详细规则
请参考 [前端硬编码规则|TYCP:硬编码规范] 和 [HTML校验规则&amp;错误编号|1.HTML校验规则&amp;错误编号] 。</p>
<p>遍历 DOM 过程中，顺便收集文档中的 IMAGE，CSS，JAVASCRIPT，FLASH 的使用情况，
文档大小，加载时间等信息。</p>
<p>对于图片，CSS，JAVASCRIPT，FLASH，如果地址中带有参数（一般为避免缓存时使用，
例如验证码，自动时间戳等），这对于统计页面的图片使用情况是无益的，收集时可以
去除，便于统计。</p>
<p>风险&amp;误差：</p>
<ol>
<li>浏览器兼容性问题，忽略某些检测造成的遗漏。</li>
<li>客户端控件、插件修改DOM会影响到检测结果的正确性。</li>
</ol>
<p>相比 HTMLint 的优势：</p>
<ol>
<li>可以检测 DOM 中使用的背景图资源信息。</li>
</ol>
<h2 id="htmlint">HTMLint<a href="#htmlint" class="anchor">¶</a></h2><p>HTMLint 在 DOMReady （一段时间）之后，通过 AJAX 再请求一次当前页面，
取得 HTML 源码之后进行解析并校验规则，将收集到的异常信息汇报到服务端。</p>
<p>校验规则大致与 DOMLint 相同，另外还包括标签非法闭合等规则（DOM 中无法检测），
详细参考 [前端硬编码规则|TYCP:硬编码规范] 和 [HTML校验规则&amp;错误编号|1.HTML校验规则&amp;错误编号] 。</p>
<p>HTML Lint 时同样会收集文档中的 IMAGE, CSS, JAVASCRIPT, FLASH 的使用情况，文档大小，加载时间等信息。</p>
<p>通过 AJAX 请求获取 HTML 源码，可能带来的风险：</p>
<ol>
<li>PV 倍增，服务器压力倍增（启用缓存可以在一定程度上避免）；</li>
<li>技术上无法获取 POST 提交结果页的 HTML 源码；</li>
<li>服务端设置的 TOKEN 导致重复请求异常，使获取的 HTML 源码和当前页面不一致；</li>
<li>重复请求对业务可能的影响（改变数据）。</li>
</ol>
<p>这种获取 HTML 源码的方式，仅适合使用 GET 访问，用于信息展示作用的页面。</p>
<p>相比 DOMLint 的优势：</p>
<ol>
<li>不受浏览器影响，也无兼容性问题需要针对某些浏览器不检测某些规则。</li>
<li>可以检测标签未结束，同一标签中出现多个同名属性等语法错误问题。</li>
</ol>
<table>
<thead>
<tr>
<th>检测内容</th>
<th>HTMLint</th>
<th>DOMLint</th>
</tr>
</thead>
<tbody>
<tr>
<td>标签未结束</td>
<td>√</td>
<td>×</td>
</tr>
<tr>
<td>标签未闭合</td>
<td>√</td>
<td>×</td>
</tr>
<tr>
<td>同名属性</td>
<td>√</td>
<td>×</td>
</tr>
<tr>
<td>文档大小</td>
<td>√</td>
<td>≈</td>
</tr>
<tr>
<td>标签的嵌套问题</td>
<td>√</td>
<td>≈</td>
</tr>
<tr>
<td>特殊标签出现次数及嵌套问题</td>
<td>√</td>
<td>≈</td>
</tr>
<tr>
<td>背景图</td>
<td>×</td>
<td>√</td>
</tr>
<tr>
<td>校验准确性</td>
<td>√</td>
<td>≈</td>
</tr>
</tbody>
</table>
<p>HTMLint 的准确性受获取源码的影响；DOMLint 的准确性稍差，会受客户端脚本和用户插件的影响。</p>
<h2 id="csslint">CSSLint<a href="#csslint" class="anchor">¶</a></h2><p>废弃。</p>
<h2 id="cssniffer">CSSniffer<a href="#cssniffer" class="anchor">¶</a></h2><p>整合在 DOMLint 遍历 DOM 的过程中，检测文档中所有元素的背景图使用情况。</p>
<p>目前没有其他使用需求，但是可扩展完全。</p>
<h2 id="数据传输">数据传输<a href="#数据传输" class="anchor">¶</a></h2><p>通过 new Image() 带上异常数据，往服务端发送 GET 请求。</p>
<p>在各浏览器和服务器中有最大 URL 长度限制：</p>
<ul>
<li>IE: 官方文档介绍的是 2083 字节，实际测试发送的图片地址长度最大可以 4095 字节，
再长就会报“无效指针）的内部错误。</li>
<li>其他浏览器，官方介绍不详，各种非官方测试结果也不同，不过实际测试结果是，
均超过 Apache 的默认最大受理长度。</li>
<li>Apache: 官方文档介绍默认是 8190 字节，实际测试 magentmng 系统的结果是 8209 字节。</li>
</ul>
<p>针对性处理，对于 IE，使用安全的官方长度（2083字节），其他浏览器使用 Apache
的最大受理长度（默认 8190 字节）。</p>
<p>对于超出的长度，分成片段数据多次发送。</p>
<p>对于 IE6 会 abort 掉 http 请求的 BUG，最终决定采用 队列+分时 的方案发送数据。</p>
<p>采用队列的另一个重要原因，是希望将一个袖珍的脚本异常嗅探脚本独立在页面顶部，
嗅探到脚本异常就 push 到队列中，当页底的发送数据的监控脚本准备好时，开始发送
队列中的数据。分时的串行发送数据，可以降低客户端和服务端的处理压力，同时避免
IE6 中的 BUG。</p>
<h2 id="see-also">See Also:<a href="#see-also" class="anchor">¶</a></h2><ol>
<li>[丢弃图片的 HTTP 请求|<a href="http://blog.hotoo.me/abort-image-request.html">http://blog.hotoo.me/abort-image-request.html</a>]</li>
<li>[IE6下链接ONCLICK事件处理中的请求被ABORTED|<a href="http://www.xiahaixia.com/2010/11/19/ie6下链接onclick事件处理中的请求被aborted/">http://www.xiahaixia.com/2010/11/19/ie6下链接onclick事件处理中的请求被aborted/</a>]</li>
<li>[What does (Aborted) mean in HttpWatch?|<a href="http://www.cnblogs.com/zhyt1985/archive/2009/05/27/1490755.html">http://www.cnblogs.com/zhyt1985/archive/2009/05/27/1490755.html</a>]
[来源|<a href="http://www.sanotes.net/html/y2008/165.html">http://www.sanotes.net/html/y2008/165.html</a>]</li>
<li>[<a href="http://blog.httpwatch.com/2007/11/20/error_internet_invalid_url-httpwatch/">http://blog.httpwatch.com/2007/11/20/error_internet_invalid_url-httpwatch/</a>]</li>
<li>[HttpWatch工具简介及使用技巧|<a href="http://www.cnblogs.com/mayingbao/archive/2007/11/30/978530.html">http://www.cnblogs.com/mayingbao/archive/2007/11/30/978530.html</a>]</li>
</ol>
<p>Abrot Image Test.</p>
<p><em>为什么不是 script/link?</em></p>
<p>使用 document.createElement(&quot;script&quot;) 创建元素并设置 src 属性，appendChild 到
DOM 中会去请求指定资源，可以到底向日志服务器发送数据的要求。</p>
<p>但是使用这种方式有一下几点弊端：</p>
<ol>
<li>创建脚本带来的危险性。</li>
<li>会向 DOM 中附加元素，影响 DOMLint 校验。</li>
<li>无法 abort，无论设置 <code>script = null;</code> <code>script.src=&quot;&quot;;</code> <code>script.src=null;</code>
<code>script.removeAttribute(&quot;src&quot;);</code> <code>document.body.removeChild(script);</code> 都无法实现 abort.</li>
<li>引入资源不触发 onload/onerror/onabort 事件，除非使用 jsonp 的方式，对元素本身无法得到回调。</li>
</ol>
<h2 id="展望">展望<a href="#展望" class="anchor">¶</a></h2><ol>
<li>JavaScript 性能检测。</li>
<li>ActionScript 异常嗅探 &amp; 性能检测。</li>
</ol>

  </div>
</article>

      </div>
      
    </div>
    <div class="footer-wrapper">
      <footer>
        <p class="footer-powered"><a href="http://spmjs.io">spmjs.io</a> •
<a href="https://github.com/spmjs/spm">spm</a> •
<a href="http://seajs.org">Sea.js</a> •
<a href="http://lab.lepture.com/nico/">nico</a>
        </p>
      </footer>
    </div>
  </body>
</html>